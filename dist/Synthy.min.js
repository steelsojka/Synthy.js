/**
 * Synthy.min.js v0.1
 *
 * A polyphonic customizable synthesizer
 * @author Steven Sojka - Wednesday, February 06, 2013
 *
 * MIT Licensed
 */
var Synthy=function(b){b.Core=function(a){a=a||{};this.context=a.context||new webkitAudioContext;this._voices={};this.load(a.patch)};b.Core.prototype={trigger:function(a){if(this.patch&&!(a in this._voices)){var c=new b.Voice(a,this.patch,this.context);c.output.connect(this.drive.input);this._voices[a]=c;c.trigger()}},release:function(a){a in this._voices&&(this._voices[a].release(),delete this._voices[a])},kill:function(){for(var a in this._voices)this._voices[a].kill()},load:function(a){a&&(this.patch=
new b.Patch(a),this.delay=new b.Delay(this.patch.fx.delay,this.context),this.drive=new b.Drive(this.patch.fx.drive,this.context),this.master=new b.Master(this.patch.master,this.context),this.drive.output.connect(this.delay.input),this.delay.output.connect(this.master.input),this.master.output.connect(this.context.destination))},save:function(){this.patch.fx.delay=this.delay.getValues();this.patch.fx.drive=this.drive.getValues();this.patch.master=this.master.getValues();return this.patch.save()}};
["setFeedback","setTime","setMix"].forEach(function(a){b.Core.prototype[a.replace("set","setDelay")]=function(){this.delay[a].apply(this.delay,arguments)}});["setAmount","setMix"].forEach(function(a){b.Core.prototype[a.replace("set","setDrive")]=function(){this.drive[a].apply(this.drive,arguments)}});["setGain"].forEach(function(a){b.Core.prototype[a.replace("set","setMaster")]=function(){this.master[a].apply(this.master,arguments)}});b.create=function(a){return new b.Core(a)};return b}(Synthy||{}),
Synthy=function(b){b.Util={noteToFreq:function(a){return 440*Math.pow(2,(a-69)/12)}};return b}(Synthy||{}),Synthy=function(){Synthy.Osc=function(b,a,c){this.context=c;this.modOsc=c.createOscillator();this.tremelo=c.createGainNode();this.osc=c.createOscillator();this.output=this.mix=c.createGainNode();this.osc.connect(this.mix);this.modOsc.connect(this.tremelo);this.tremelo.connect(this.osc.frequency);this.tremelo.gain.value=b.mod.mix;this.modOsc.frequency.value=b.mod.rate;this.modOsc.type=b.mod.type;
this.range=b.range;this.harmony=b.harmony;this.osc.frequency.value=Synthy.Util.noteToFreq(a+12*this.range+this.harmony);this.osc.detune.value=b.detune;this.osc.type=b.type;this.mix.gain.value=b.mix};Synthy.Osc.prototype={trigger:function(){this.modOsc.start(0);this.osc.start(0)},release:function(b){var a=this.context.currentTime;this.modOsc.stop(a+b);this.osc.stop(a+b)},kill:function(){this.modOsc.stop(0);this.osc.stop(0)}};return Synthy}(Synthy||{}),Synthy=function(b){b.Envelope=function(a,b){this.context=
b;this.envelope=b.createGainNode();this.envelope.gain.value=0;this.patch=a;this.input=this.output=this.envelope};b.Envelope.prototype={trigger:function(){var a=this.context.currentTime,b=this.envelope.gain,d=a+this.patch.attack/10;b.setValueAtTime(0,a);b.linearRampToValueAtTime(1,d);b.setTargetValueAtTime(this.patch.sustain/100,d,this.patch.decay/100+0.0010)},release:function(){var a=this.context.currentTime,b=this.envelope.gain;b.cancelScheduledValues(a);b.setValueAtTime(b.value,a);b.linearRampToValueAtTime(0,
a+this.patch.release/100)},getReleaseTime:function(){return this.patch.release/100}};return b}(Synthy||{}),Synthy=function(b){b.Filter=function(a,c,d){this.context=d;this.filter=d.createBiquadFilter();this.filter.frequency.value=a.cutoff;this.filter.Q.value=a.q;this.filter.type=a.type;this.freq=b.Util.noteToFreq(c);this.env=a.env;this.patch=a;this.input=this.output=this.filter};b.Filter.prototype={trigger:function(){var a=this.patch,b=this.context.currentTime,d=this.filter.frequency;this.startLevel=
this.frequencyFromCutoff(a.cutoff/100);this.attackLevel=this.frequencyFromCutoff(a.cutoff/100+this.env/120);this.sustainLevel=this.frequencyFromCutoff(a.cutoff/100+this.env/120*(a.sustain/100));this.attackEnd=b+a.attack/20;d.value=this.startLevel;d.setValueAtTime(this.startLevel,b);d.linearRampToValueAtTime(this.attackLevel,this.attackEnd);d.setTargetValueAtTime(this.sustainLevel,this.attackEnd,a.decay/100)},frequencyFromCutoff:function(a){var b=0.5*this.context.sampleRate,a=Math.pow(2,9*a-1)*this.freq;
a>b&&(a=b);return a},release:function(){var a=this.context.currentTime,b=this.filter.frequency;b.cancelScheduledValues(a);b.setValueAtTime(b.value,a);b.linearRampToValueAtTime(this.startLevel,a+this.patch.release/100)}};return b}(Synthy||{}),Synthy=function(b){b.Master=function(a,b){this.input=this.output=b.createGainNode();this.output.gain.value=a.output};b.Master.prototype={setGain:function(a){this.output.gain.value=a},getValues:function(){return{output:this.output.gain.value}}};return b}(Synthy||
{}),Synthy=function(){Synthy.Voice=function(b,a,c){this.osc=[];this.envelope=new Synthy.Envelope(a.envelope,c);this.filter=new Synthy.Filter(a.filter,b,c);for(var d=0,e=a.osc.length;d<e;d++)this.osc.push(new Synthy.Osc(a.osc[d],b,c)),this.osc[d].output.connect(this.filter.input);this.filter.output.connect(this.envelope.input);this.output=this.envelope.input};Synthy.Voice.prototype={trigger:function(){for(var b=0,a=this.osc.length;b<a;b++)this.osc[b].trigger();this.filter.trigger();this.envelope.trigger()},
release:function(){var b=this.envelope.getReleaseTime();this.envelope.release();this.filter.release();for(var a=0,c=this.osc.length;a<c;a++)this.osc[a].release(b)},destroy:function(){this.output.disconnect(0)},kill:function(){for(var b=0,a=this.osc.length;b<a;b++)this.osc[b].kill()}};return Synthy}(Synthy||{}),Synthy=function(){Synthy.Patch=function(b){for(var a in b)b.hasOwnProperty(a)&&(this[a]=b[a])};Synthy.Patch.prototype={save:function(){var b={},a;for(a in this)this.hasOwnProperty(a)&&(b[a]=
this[a]);return JSON.stringify(b)},setOscProperty:function(b,a,c){this.osc[b][a]=c},setFilterProperty:function(b,a){this.filter[b]=a},setMaster:function(b,a){this.master[b]=a}};["attack","decay","sustain","release"].forEach(function(b){Synthy.Patch.prototype["setEnvelope"+(b.charAt(0).toUpperCase()+b.slice(1))]=function(a){this.envelope[b]=a}});return Synthy}(Synthy||{}),Synthy=function(b){b.Drive=function(a,b){this.context=b;this.drive=b.createWaveShaper();this.input=b.createGainNode();this.output=
b.createGainNode();this.driveOutput=b.createGainNode();this.input.connect(this.drive);this.input.connect(this.output);this.drive.connect(this.driveOutput);this.driveOutput.connect(this.output);this.setAmount(a.drive);this.setMix(a.mix)};b.Drive.prototype={setAmount:function(a){this.amount=a;for(var b=this.drive,d=new Float32Array(22050),a=2*a/(1-a),e=0;22050>e;e+=1){var f=2*(e-0)/22050+-1;d[e]=(1+a)*f/(1+a*Math.abs(f))}b.curve=d},setMix:function(a){this.driveOutput.gain.value=a},getValues:function(){return{drive:this.amount,
mix:this.driveOutput.gain.value}}};return b}(Synthy||{}),Synthy=function(b){b.Delay=function(a,b){this.context=b;this.delay=b.createDelay();this.gain=b.createGainNode();this.output=b.createGainNode();this.delayGain=b.createGainNode();this.input=b.createGainNode();this.delay.connect(this.gain);this.gain.connect(this.delay);this.input.connect(this.delay);this.delay.connect(this.delayGain);this.delayGain.connect(this.output);this.input.connect(this.output);this.setFeedback(a.feedback);this.setTime(a.time);
this.setMix(a.wet)};b.Delay.prototype={setFeedback:function(a){this.gain.gain.value=a},setTime:function(a){this.delay.delayTime.value=a},setMix:function(a){this.delayGain.gain.value=a},getValues:function(){return{feedback:this.gain.gain.value,time:this.delay.delayTime.value,wet:this.delayGain.gain.value}}};return b}(Synthy||{});
