/**
 * Synthy.min.js v0.1
 *
 * A polyphonic customizable synthesizer
 * @author Steven Sojka - Thursday, February 07, 2013
 *
 * MIT Licensed
 */
var Synthy=function(b){b.Core=function(a){a=a||{};this.context=a.context||new webkitAudioContext;this._voices={};this.load(a.patch)};b.Core.prototype={trigger:function(a){if(this.patch&&!(a in this._voices)){var c=new b.Voice(a,this.patch,this.context);c.output.connect(this.drive.input);this._voices[a]=c;c.trigger()}},release:function(a){a in this._voices&&(this._voices[a].release(),delete this._voices[a])},kill:function(){for(var a in this._voices)this._voices[a].kill()},load:function(a){a&&(this.patch=
new b.Patch(a),this.delay=new b.Delay(this.patch.fx.delay,this.context),this.drive=new b.Drive(this.patch.fx.drive,this.context),this.master=new b.Master(this.patch.master,this.context),this.drive.output.connect(this.delay.input),this.delay.output.connect(this.master.input),this.master.output.connect(this.context.destination))},save:function(a){this.patch.fx.delay=this.delay.getValues();this.patch.fx.drive=this.drive.getValues();this.patch.master=this.master.getValues();return this.patch.save(a)},
addOscillator:function(a){this.patch.addOscillator(a)}};["setFeedback","setTime","setMix"].forEach(function(a){b.Core.prototype[a.replace("set","setDelay")]=function(){this.delay[a].apply(this.delay,arguments)}});["setAmount","setMix","setType"].forEach(function(a){b.Core.prototype[a.replace("set","setDrive")]=function(){this.drive[a].apply(this.drive,arguments)}});["setGain"].forEach(function(a){b.Core.prototype[a.replace("set","setMaster")]=function(){this.master[a].apply(this.master,arguments)}});
"Cutoff Q Modulation Type Envelope Attack Decay Sustain Release".split(" ").forEach(function(a){b.Core.prototype["setFilter"+a]=function(b){this.patch.setFilterProperty(a.toLowerCase(),b)}});["Attack","Decay","Sustain","Release"].forEach(function(a){b.Core.prototype["setEnvelope"+a]=function(b){this.patch.setEnvelopeProperty(a.toLowerCase(),b)}});"ModRate ModMix ModType Range Detune Mix Type Harmony DriveAmount DriveMix DriveType".split(" ").forEach(function(a){b.Core.prototype["setOsc"+a]=function(b,
e){this.patch.setOscillatorProperty(b,a.charAt(0).toLowerCase()+a.slice(1),e)}});b.create=function(a){return new b.Core(a)};return b}(Synthy||{}),Synthy=function(b){b.Util={noteToFreq:function(a){return 440*Math.pow(2,(a-69)/12)}};return b}(Synthy||{}),Synthy=function(){Synthy.Osc=function(b,a,c){this.context=c;this.modOsc=c.createOscillator();this.tremelo=c.createGainNode();this.osc=c.createOscillator();this.mix=c.createGainNode();this.gate=c.createOscillator();this.gateGain=c.createGainNode();this.output=
this.mix;this.osc.connect(this.mix);this.modOsc.connect(this.tremelo);this.tremelo.connect(this.osc.frequency);this.tremelo.gain.value=b.modMix;this.modOsc.frequency.value=b.modRate;this.modOsc.type=b.modType;this.range=b.range;this.harmony=b.harmony;this.osc.frequency.value=Synthy.Util.noteToFreq(a+12*this.range+this.harmony);this.osc.detune.value=b.detune;this.osc.type=b.type;this.mix.gain.value=b.mix};Synthy.Osc.prototype={trigger:function(){this.modOsc.start(0);this.osc.start(0)},release:function(b){var a=
this.context.currentTime;this.modOsc.stop(a+b);this.osc.stop(a+b)},kill:function(){this.modOsc.stop(0);this.osc.stop(0)}};return Synthy}(Synthy||{}),Synthy=function(b){b.Envelope=function(a,b){this.context=b;this.envelope=b.createGainNode();this.envelope.gain.value=0;this.patch=a;this.input=this.output=this.envelope};b.Envelope.prototype={trigger:function(){var a=this.context.currentTime,b=this.envelope.gain,e=a+this.patch.attack/10;b.setValueAtTime(0,a);b.linearRampToValueAtTime(1,e);b.setTargetValueAtTime(this.patch.sustain/
100,e,this.patch.decay/100+0.0010)},release:function(){var a=this.context.currentTime,b=this.envelope.gain;b.cancelScheduledValues(a);b.setValueAtTime(b.value,a);b.linearRampToValueAtTime(0,a+this.patch.release/100)},getReleaseTime:function(){return this.patch.release/100}};return b}(Synthy||{}),Synthy=function(b){b.Filter=function(a,c,e){this.context=e;this.filter=e.createBiquadFilter();this.filter.frequency.value=a.cutoff;this.filter.Q.value=a.q;this.filter.type=a.type;this.freq=b.Util.noteToFreq(c);
this.env=a.envelope;this.patch=a;this.input=this.output=this.filter};b.Filter.prototype={trigger:function(){var a=this.patch,b=this.context.currentTime,e=this.filter.frequency;this.startLevel=this.frequencyFromCutoff(a.cutoff/100);this.attackLevel=this.frequencyFromCutoff(a.cutoff/100+this.env/120);this.sustainLevel=this.frequencyFromCutoff(a.cutoff/100+this.env/120*(a.sustain/100));this.attackEnd=b+a.attack/20;e.value=this.startLevel;e.setValueAtTime(this.startLevel,b);e.linearRampToValueAtTime(this.attackLevel,
this.attackEnd);e.setTargetValueAtTime(this.sustainLevel,this.attackEnd,a.decay/100)},frequencyFromCutoff:function(a){var b=0.5*this.context.sampleRate,a=Math.pow(2,9*a-1)*this.freq;a>b&&(a=b);return a},release:function(){var a=this.context.currentTime,b=this.filter.frequency;b.cancelScheduledValues(a);b.setValueAtTime(b.value,a);b.linearRampToValueAtTime(this.startLevel,a+this.patch.release/100)}};return b}(Synthy||{}),Synthy=function(b){b.Master=function(a,b){this.input=this.output=b.createGainNode();
this.output.gain.value=a.output};b.Master.prototype={setGain:function(a){this.output.gain.value=a},getValues:function(){return{output:this.output.gain.value}}};return b}(Synthy||{}),Synthy=function(){Synthy.Voice=function(b,a,c){this.osc=[];this.driveFx=[];this.envelope=new Synthy.Envelope(a.envelope,c);this.filter=new Synthy.Filter(a.filter,b,c);for(var e=0,j=a.osc.length;e<j;e++)this.osc.push(new Synthy.Osc(a.osc[e],b,c)),this.driveFx.push(new Synthy.Drive({drive:a.osc[e].driveAmount,mix:a.osc[e].driveMix,
type:a.osc[e].driveType},c)),this.osc[e].output.connect(this.driveFx[e].input),this.driveFx[e].output.connect(this.filter.input);this.filter.output.connect(this.envelope.input);this.output=this.envelope.input};Synthy.Voice.prototype={trigger:function(){for(var b=0,a=this.osc.length;b<a;b++)this.osc[b].trigger();this.filter.trigger();this.envelope.trigger()},release:function(){var b=this.envelope.getReleaseTime();this.envelope.release();this.filter.release();for(var a=0,c=this.osc.length;a<c;a++)this.osc[a].release(b);
setTimeout(this.destroy.bind(this),1E3*b)},destroy:function(){this.output.disconnect(0)},kill:function(){for(var b=0,a=this.osc.length;b<a;b++)this.osc[b].kill()}};return Synthy}(Synthy||{}),Synthy=function(){Synthy.Patch=function(b){for(var a in b)b.hasOwnProperty(a)&&(this[a]=b[a])};Synthy.Patch.prototype={save:function(b){var a={},c;for(c in this)this.hasOwnProperty(c)&&(a[c]=this[c]);return JSON.stringify(a,null,b)},setOscillatorProperty:function(b,a,c){this.osc[b]&&a in this.osc[b]&&(this.osc[b][a]=
c)},addOscillator:function(b){var b=b||{},a={modRate:0,modMix:0,modType:1,range:0,detune:0,mix:1,type:0,harmony:0,driveAmount:0,driveMix:0,driveType:0},c;for(c in a)a.hasOwnProperty(c)&&c in b&&(a[c]=b[c]);this.osc.push(a)}};["Filter","Envelope"].forEach(function(b){Synthy.Patch.prototype["set"+b+"Property"]=function(a,c){a in this[b.toLowerCase()]&&(this[b.toLowerCase()][a]=c)}});return Synthy}(Synthy||{}),Synthy=function(b){var a=function(a){return(Math.exp(a)-Math.exp(-a))/(Math.exp(a)+Math.exp(-a))},
c=[function(a,b,c){var a=Math.min(a,0.9999),a=2*a/(1-a),d,f;for(d=0;d<b;d++)f=2*d/b-1,c[d]=(1+a)*f/(1+a*Math.abs(f))},function(b,c,i){for(var d,f,b=0;b<c;b++)d=2*b/c-1,f=0<=(0.5*Math.pow(d+1.4,2)-1)*f?5.8:1.2,i[b]=a(f)},function(b,c,i){for(var d,f=1-b,b=0;b<c;b++)d=2*b/c-1,d=0>d?-Math.pow(Math.abs(d),f+0.04):Math.pow(d,f),i[b]=a(2*d)},function(a,b,c){for(var d,f,g,h=0.99<1-a?0.99:1-a,a=0;a<b;a++){d=2*a/b-1;g=Math.abs(d);g<h?f=g:g>h?f=h+(g-h)/(1+Math.pow((g-h)/(1-h),2)):1<g&&(f=g);g=c;var k=a;d=0===
d?1:Math.abs(d)/d;g[k]=d*f*(1/((h+1)/2))}},function(a,b,c){for(var d,a=0;a<b;a++)d=2*a/b-1,c[a]=-0.08905>d?-0.75*(1-Math.pow(1-(Math.abs(d)-0.032857),12)+1/3*(Math.abs(d)-0.032847))+0.01:-0.08905<=d&&0.320018>d?-6.153*d*d+3.9375*d:0.630035},function(a,b,c){var a=2+Math.round(14*a),a=Math.round(Math.pow(2,a-1)),d,f;for(d=0;d<b;d++)f=2*d/b-1,c[d]=Math.round(f*a)/a}];b.Drive=function(a,b){this.context=b;this.drive=b.createWaveShaper();this.input=b.createGainNode();this.output=b.createGainNode();this.driveOutput=
b.createGainNode();this.dryOutput=b.createGainNode();this.waveTable=new Float32Array(b.sampleRate);this.input.connect(this.drive);this.input.connect(this.dryOutput);this.dryOutput.connect(this.output);this.drive.connect(this.driveOutput);this.driveOutput.connect(this.output);this.setMix(a.mix);this.setType(a.type);this.setAmount(a.drive)};b.Drive.prototype={setAmount:function(a){this.amount=a;c[this.type](a,this.context.sampleRate,this.waveTable);this.drive.curve=this.waveTable},setType:function(a){a>
c.length-1||0>a||(this.type=a,c[this.type](this.amount,this.context.sampleRate,this.waveTable))},setMix:function(a){1<a&&(a=1);this.dryOutput.gain.value=1-a;this.driveOutput.gain.value=a},getValues:function(){return{drive:this.amount,mix:this.driveOutput.gain.value}}};return b}(Synthy||{}),Synthy=function(b){b.Delay=function(a,b){this.context=b;this.delay=b.createDelay();this.gain=b.createGainNode();this.output=b.createGainNode();this.delayGain=b.createGainNode();this.input=b.createGainNode();this.delay.connect(this.gain);
this.gain.connect(this.delay);this.input.connect(this.delay);this.delay.connect(this.delayGain);this.delayGain.connect(this.output);this.input.connect(this.output);this.setFeedback(a.feedback);this.setTime(a.time);this.setMix(a.wet)};b.Delay.prototype={setFeedback:function(a){this.gain.gain.value=a},setTime:function(a){this.delay.delayTime.value=a},setMix:function(a){this.delayGain.gain.value=a},getValues:function(){return{feedback:this.gain.gain.value,time:this.delay.delayTime.value,wet:this.delayGain.gain.value}}};
return b}(Synthy||{}),Synthy=function(b){var a={65:45,87:46,83:47,69:48,68:49,70:50,84:51,71:52,89:53,72:54,85:55,74:56,75:57,79:58,76:59},c=0;b.keyToMidi=function(b){if(b in a)return a[b]+12*c};b.shiftOctave=function(a){c+=a};return b}(Synthy||{});
