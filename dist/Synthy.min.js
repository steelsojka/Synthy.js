/**
 * Synthy.min.js v0.2.0
 *
 * A polyphonic customizable synthesizer
 * @author Steven Sojka - Monday, February 18, 2013
 *
 * MIT Licensed
 */
var Synthy=function(a){a.Emitter=function(){};a.Emitter.prototype={on:function(b,a,e){b=b.split(" ");this.__events=this.__events||{};for(var h=0,g=b.length;h<g;h++)this.__events[b[h]]=this.__events[b[h]]||[],this.__events[b[h]].push(e?a.bind(e):a)},off:function(b,a){this.__events=this.__events||{};b in this.__events&&(a?this.__events[b].splice(this.__events[b].indexOf(a),1):delete this.__events[b])},emit:function(b){this.__events=this.__events||{};if(b in this.__events)for(var a=0,e=this.__events[b].length;a<
e;a++)this.__events[b][a].apply(this,Array.prototype.slice.call(arguments,1))}};a.Emitter.register=function(b){for(var c in a.Emitter.prototype)a.Emitter.prototype.hasOwnProperty(c)&&(b.prototype[c]=a.Emitter.prototype[c])};return a}(Synthy||{}),Synthy=function(a){a.Core=function(b){b=b||{};this.context=b.context||new webkitAudioContext;this._voices={};this.timer=new a.AudioTimer(this.context);this.load(b.patch)};a.Core.prototype={trigger:function(b,c,e){if(this.patch&&!(b in this._voices)){var h=
this,g=new a.Voice({noteNumber:b,velocity:c,timer:this.timer},this.patch,this.context);this.on("kill",g.kill,g);this._voices[b]||(this._voices[b]=[]);this._voices[b].push(g);this.timer.callbackAtTime(e-0.1,function(){g.output.connect(h.drive.input);g.trigger(e)})}},release:function(b,a){if(b in this._voices){var e=this._voices[b].pop(),h=this;e.release(a);e.on("destroy",function(){h.off("kill",e.kill)});delete this._voices[b]}},kill:function(){this.emit("kill");this.off("kill");this.timer.clearCallbacks();
this._voices={}},load:function(b){b&&(this.patch=new a.Patch(b),this.delay=new a.Delay(this.patch.fx.delay,this.context),this.drive=new a.Drive(this.patch.fx.drive,this.context),this.master=new a.Master(this.patch.master,this.context),this.drive.output.connect(this.delay.input),this.delay.output.connect(this.master.input),this.master.output.connect(this.context.destination))},save:function(b){this.patch.fx.delay=this.delay.getValues();this.patch.fx.drive=this.drive.getValues();this.patch.master=this.master.getValues();
return this.patch.save(b)},addOscillator:function(b){this.patch.addOscillator(b)}};["setFeedback","setTime","setMix"].forEach(function(b){a.Core.prototype[b.replace("set","setDelay")]=function(){this.delay[b].apply(this.delay,arguments)}});["setAmount","setMix","setType"].forEach(function(b){a.Core.prototype[b.replace("set","setDrive")]=function(){this.drive[b].apply(this.drive,arguments)}});["setGain"].forEach(function(b){a.Core.prototype[b.replace("set","setMaster")]=function(){this.master[b].apply(this.master,
arguments)}});"Cutoff Q Modulation Type Envelope Attack Decay Sustain Release".split(" ").forEach(function(b){a.Core.prototype["setFilter"+b]=function(a){this.patch.setFilterProperty(b.toLowerCase(),a)}});["Attack","Decay","Sustain","Release"].forEach(function(b){a.Core.prototype["setEnvelope"+b]=function(a){this.patch.setEnvelopeProperty(b.toLowerCase(),a)}});"ModRate ModMix ModType Range Detune Mix Type Harmony DriveAmount DriveMix DriveType".split(" ").forEach(function(b){a.Core.prototype["setOsc"+
b]=function(a,e){this.patch.setOscillatorProperty(a,b.charAt(0).toLowerCase()+b.slice(1),e)}});a.Emitter.register(a.Core);a.create=function(b){return new a.Core(b)};return a}(Synthy||{}),Synthy=function(a){a.Util={noteToFreq:function(b){return 440*Math.pow(2,(b-69)/12)}};return a}(Synthy||{}),Synthy=function(a){var b=function(b){for(var a=this._callbacks.length,c=this.context.currentTime,d=this._callbacks,f;a--;)if(f=d[a],f[0]<=c)if(f=d.splice(d.indexOf(f),1)[0],f[2])f[1].call(f[2],b);else f[1](b)},
c=function(a,c){null==c&&(c=512);this._callbacks=[];this.context=a||new webkitAudioContext;this.node=this.context.createScriptProcessor(c,1,1);this.node.onaudioprocess=b.bind(this);this.node.connect(this.context.destination)};c.prototype={callbackAtTime:function(b,a,c){this._callbacks.push([b,a,c])},clearCallbacks:function(){this._callbacks=[]},removeCallbackAtTime:function(b,a){for(var c=this._callbacks,d=c.length,f;d--;)f=c[d],f[1]===b&&(void 0!==a?a===f[0]&&c.splice(c.indexOf(f),1):c.splice(c.indexOf(f),
1))}};a.AudioTimer=c;return a}(Synthy||{}),Synthy=function(){Synthy.Osc=function(a,b,c,e){this.context=e;this.modOsc=e.createOscillator();this.tremelo=e.createGainNode();this.osc=e.createOscillator();this.mix=e.createGainNode();this.vGain=e.createGainNode();this.output=this.mix;this.osc.connect(this.vGain);this.vGain.connect(this.mix);this.modOsc.connect(this.tremelo);this.tremelo.connect(this.osc.frequency);this.tremelo.gain.value=a.modMix;this.modOsc.frequency.value=a.modRate;this.modOsc.type=a.modType;
this.range=a.range;this.harmony=a.harmony;this.osc.frequency.value=Synthy.Util.noteToFreq(b+12*this.range+this.harmony);this.osc.detune.value=a.detune;this.osc.type=a.type;this.mix.gain.value=a.mix;this.vGain.gain.value=c/127};Synthy.Osc.prototype={trigger:function(a){null==a&&(a=0);this.modOsc.start(a);this.osc.start(a)},release:function(a){this.modOsc.stop(a);this.osc.stop(a)},kill:function(){this.modOsc.stop(0);this.osc.stop(0);this.modOsc.disconnect(0);this.osc.disconnect(0)}};Synthy.Emitter.register(Synthy.Osc);
return Synthy}(Synthy||{}),Synthy=function(a){a.Envelope=function(b,a){this.context=a;this.envelope=a.createGainNode();this.envelope.gain.value=0;this.patch=b;this.input=this.output=this.envelope};a.Envelope.prototype={trigger:function(b){var b=b||this.context.currentTime,a=this.envelope.gain,e=b+this.patch.attack/10;a.setValueAtTime(0,b);a.linearRampToValueAtTime(1,e);a.setTargetValueAtTime(this.patch.sustain/100,e,this.patch.decay/100+0.0010)},release:function(b){var b=b||this.context.currentTime,
a=this.envelope.gain;a.cancelScheduledValues(b);a.setValueAtTime(a.value,b);a.linearRampToValueAtTime(0,b+this.patch.release/100)},getReleaseTime:function(){return this.patch.release/100}};return a}(Synthy||{}),Synthy=function(a){a.Filter=function(b,c,e){this.context=e;this.filter=e.createBiquadFilter();this.filter.frequency.value=b.cutoff;this.filter.Q.value=b.q;this.filter.type=b.type;this.freq=a.Util.noteToFreq(c);this.env=b.envelope;this.patch=b;this.input=this.output=this.filter};a.Filter.prototype=
{trigger:function(b){var a=this.patch,b=b||this.context.currentTime,e=this.filter.frequency;this.startLevel=this.frequencyFromCutoff(a.cutoff/100);this.attackLevel=this.frequencyFromCutoff(a.cutoff/100+this.env/120);this.sustainLevel=this.frequencyFromCutoff(a.cutoff/100+this.env/120*(a.sustain/100));this.attackEnd=b+a.attack/20;e.value=this.startLevel;e.setValueAtTime(this.startLevel,b);e.linearRampToValueAtTime(this.attackLevel,this.attackEnd);e.setTargetValueAtTime(this.sustainLevel,this.attackEnd,
a.decay/100)},frequencyFromCutoff:function(a){var c=0.5*this.context.sampleRate,a=Math.pow(2,9*a-1)*this.freq;a>c&&(a=c);return a},release:function(a){var a=a||this.context.currentTime,c=this.filter.frequency;c.cancelScheduledValues(a);c.setValueAtTime(c.value,a);c.linearRampToValueAtTime(this.startLevel,a+this.patch.release/100)}};return a}(Synthy||{}),Synthy=function(a){a.Master=function(a,c){this.input=this.output=c.createGainNode();this.output.gain.value=a.output};a.Master.prototype={setGain:function(a){this.output.gain.value=
a},getValues:function(){return{output:this.output.gain.value}}};return a}(Synthy||{}),Synthy=function(){Synthy.Voice=function(a,b,c){var e=a.noteNumber,h=a.velocity||127,g=this;this.timer=a.timer;this.osc=[];this.driveFx=[];this.envelope=new Synthy.Envelope(b.envelope,c);this.filter=new Synthy.Filter(b.filter,e,c);b.osc.forEach(function(a){var b=new Synthy.Osc(a,e,h,c),a=new Synthy.Drive({drive:a.driveAmount,mix:a.driveMix,type:a.driveType},c);g.osc.push(b);g.driveFx.push(a);g.on("kill",b.kill,b);
b.output.connect(a.input);a.output.connect(g.filter.input)});this.filter.output.connect(this.envelope.input);this.output=this.envelope.input};Synthy.Voice.prototype={trigger:function(a){null==a&&(a=0);for(var b=0,c=this.osc.length;b<c;b++)this.osc[b].trigger(a);this.filter.trigger(a);this.envelope.trigger(a)},release:function(a){var b=this.envelope.getReleaseTime(),c=a||0;this.envelope.release(a);this.filter.release(a);for(var a=0,e=this.osc.length;a<e;a++)this.osc[a].release(c+b);this.killTime=c+
b;this.timer.callbackAtTime(this.killTime,this.destroy,this)},destroy:function(){this.emit("destroy");this.output.disconnect(0)},kill:function(){this.timer.removeCallbackAtTime(this.destroy,this.killTime);this.emit("kill");this.output.disconnect(0)}};Synthy.Emitter.register(Synthy.Voice);return Synthy}(Synthy||{}),Synthy=function(){Synthy.Patch=function(a){for(var b in a)a.hasOwnProperty(b)&&(this[b]=a[b])};Synthy.Patch.prototype={save:function(a){var b={},c;for(c in this)this.hasOwnProperty(c)&&
(b[c]=this[c]);return JSON.stringify(b,null,a)},setOscillatorProperty:function(a,b,c){this.osc[a]&&b in this.osc[a]&&(this.osc[a][b]=c)},addOscillator:function(a){var a=a||{},b={modRate:0,modMix:0,modType:1,range:0,detune:0,mix:1,type:0,harmony:0,driveAmount:0,driveMix:0,driveType:0},c;for(c in b)b.hasOwnProperty(c)&&c in a&&(b[c]=a[c]);this.osc.push(b)}};["Filter","Envelope"].forEach(function(a){Synthy.Patch.prototype["set"+a+"Property"]=function(b,c){b in this[a.toLowerCase()]&&(this[a.toLowerCase()][b]=
c)}});return Synthy}(Synthy||{}),Synthy=function(a){var b=function(a){return(Math.exp(a)-Math.exp(-a))/(Math.exp(a)+Math.exp(-a))},c=[function(a,b,c){var a=Math.min(a,0.9999),a=2*a/(1-a),d,f;for(d=0;d<b;d++)f=2*d/b-1,c[d]=(1+a)*f/(1+a*Math.abs(f))},function(a,c,g){for(var d,f,a=0;a<c;a++)d=2*a/c-1,f=0<=(0.5*Math.pow(d+1.4,2)-1)*f?5.8:1.2,g[a]=b(f)},function(a,c,g){for(var d,f=1-a,a=0;a<c;a++)d=2*a/c-1,d=0>d?-Math.pow(Math.abs(d),f+0.04):Math.pow(d,f),g[a]=b(2*d)},function(a,b,c){for(var d,f,i,j=0.99<
1-a?0.99:1-a,a=0;a<b;a++){d=2*a/b-1;i=Math.abs(d);i<j?f=i:i>j?f=j+(i-j)/(1+Math.pow((i-j)/(1-j),2)):1<i&&(f=i);i=c;var k=a;d=0===d?1:Math.abs(d)/d;i[k]=d*f*(1/((j+1)/2))}},function(a,b,c){for(var d,a=0;a<b;a++)d=2*a/b-1,c[a]=-0.08905>d?-0.75*(1-Math.pow(1-(Math.abs(d)-0.032857),12)+1/3*(Math.abs(d)-0.032847))+0.01:-0.08905<=d&&0.320018>d?-6.153*d*d+3.9375*d:0.630035},function(a,b,c){var a=2+Math.round(14*a),a=Math.round(Math.pow(2,a-1)),d,f;for(d=0;d<b;d++)f=2*d/b-1,c[d]=Math.round(f*a)/a}];a.Drive=
function(a,b){this.context=b;this.drive=b.createWaveShaper();this.input=b.createGainNode();this.output=b.createGainNode();this.driveOutput=b.createGainNode();this.dryOutput=b.createGainNode();this.waveTable=new Float32Array(b.sampleRate);this.input.connect(this.drive);this.input.connect(this.dryOutput);this.dryOutput.connect(this.output);this.drive.connect(this.driveOutput);this.driveOutput.connect(this.output);this.setMix(a.mix);this.setType(a.type);this.setAmount(a.drive)};a.Drive.prototype={setAmount:function(a){this.amount=
a;c[this.type](a,this.context.sampleRate,this.waveTable);this.drive.curve=this.waveTable},setType:function(a){a>c.length-1||0>a||(this.type=a,c[this.type](this.amount,this.context.sampleRate,this.waveTable))},setMix:function(a){1<a&&(a=1);this.dryOutput.gain.value=1-a;this.driveOutput.gain.value=a},getValues:function(){return{drive:this.amount,mix:this.driveOutput.gain.value}}};return a}(Synthy||{}),Synthy=function(a){a.Delay=function(a,c){this.context=c;this.delay=c.createDelay();this.gain=c.createGainNode();
this.output=c.createGainNode();this.delayGain=c.createGainNode();this.input=c.createGainNode();this.delay.connect(this.gain);this.gain.connect(this.delay);this.input.connect(this.delay);this.delay.connect(this.delayGain);this.delayGain.connect(this.output);this.input.connect(this.output);this.setFeedback(a.feedback);this.setTime(a.time);this.setMix(a.wet)};a.Delay.prototype={setFeedback:function(a){this.gain.gain.value=a},setTime:function(a){this.delay.delayTime.value=a},setMix:function(a){this.delayGain.gain.value=
a},getValues:function(){return{feedback:this.gain.gain.value,time:this.delay.delayTime.value,wet:this.delayGain.gain.value}}};return a}(Synthy||{}),Synthy=function(a){var b={65:45,87:46,83:47,69:48,68:49,70:50,84:51,71:52,89:53,72:54,85:55,74:56,75:57,79:58,76:59},c=0;a.keyToMidi=function(a){if(a in b)return b[a]+12*c};a.shiftOctave=function(a){c+=a};return a}(Synthy||{});
